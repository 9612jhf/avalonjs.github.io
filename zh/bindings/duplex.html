<h2>双工绑定(ms-duplex)</h2>
<p>ms-duplex是所有绑定属性中唯一能从V到VM同步的绑定，其余的绑定只能单向地从VM到V地同步。</p>
<p>ms-duplex的语法为<strong>ms-duplex="prop"</strong>，注意属性值只能是一个属性值，不是表达式，比如我们
    可以ms-duplex="aaa.bbb", ms-duplex="xxx", ms-duplex="aaa.bbb.ccc"，但不能是ms-duplex="fn(aaa)", ms-duplex="aaa+bbb"。
    这正是因为它是双向的，它需要将当前表单元素的值，再赋给VM的某一个属性，而不能赋给一个表达式。
</p>
<p>此外，ms-duplex还有许多分支或叫衍生绑定，如<code class="language-javascript">ms-duplex-boolean</code>, 
    <code class="language-javascript">ms-duplex-string</code>,
    <code class="language-javascript">ms-duplex-number</code>,
    <code class="language-javascript">ms-duplex-checked</code>
    这4个是1.3.7后新增的(统称之为ms-duplex 2.0)，在之前，还有另外几个绑定与它们有着相同的功能。详看下表：
</p>

<p>旧有的ms-duplex家族与新的ms-duplex家族对比如下：</p>

<table class="shim-table"> 
    <col width="190"><col width="220">
    <tr><td>新</td><td>旧</td><td>功能</td></tr>
    <tr><td>
            <code class='language-javascript'>ms-duplex-checked</code>
            <br>只能应用于radio、 checkbox
        </td>
        <td>
            <code class='language-javascript'>ms-duplex</code>
            <br>只能应用于radio
            <br><code class='language-javascript'>ms-duplex-radio</code>
            <br>checkbox
        </td>
        <td>通过checked属性同步VM</td>
    </tr>
    <tr>
        <td>
            <code class='language-javascript'>ms-duplex-string</code>
            <br>应用于所有表单元素
        </td>
        <td>
            <code class='language-javascript'>ms-duplex-text</code>
            <br>只能应用于radio
        </td>
        <td>通过value属性同步VM</td>
    </tr>
    <tr>
        <td>
            <code class='language-javascript'>ms-duplex-boolean</code>
            <br>应用于所有表单元素
        </td>
        <td>
            <code class='language-javascript'>ms-duplex-bool</code>
            <br>只能应用于radio
        </td>
        <td>value为&#8221;true&#8221;时转为true，其他值转为false同步VM</td>
    </tr>
    <tr>
        <td>
            <code class='language-javascript'>ms-duplex-number</code>
            <br>应用于表单元素
        </td>
        <td>没有对应项</td>
        <td>如果value是数字格式就转换为数值，否则不做转换，然后再同步VM</td>
    </tr>
    <tr>
        <td>
            <code class='language-javascript'>ms-duplex</code>
            <br>相当于ms-duplex-string
        </td>
        <td>
            <code class='language-javascript'>ms-duplex</code>
            <br>在radio相当于ms-duplex-checked
            <br>在其他上相当于ms-duplex-string</td>
        <td>见上</td>
    </tr>
</table>

<p>在avalon1.3.7中，添加了avalon.duplexHooks钩子对象， 什么ms-duplex-boolean都可以在它上面找到实现：</p>

<pre class="brush:javascript;gutter:false;toolbar:false">

function fixNull(val) {
        return val == null ? "" : val
    }
    avalon.duplexHooks = {
        checked: {
            get: function(val, data) {
                return !data.element.oldValue
            }
        },
        string: {
            get: function(val) {//同步到VM
                return val
            },
            set: fixNull
        },
        "boolean": {
            get: function(val) {
                return val === "true"
            },
            set: fixNull
        },
        number: {
            get: function(val) {
                return isFinite(val) ? parseFloat(val) || 0 : val
            },
            set: fixNull
        }
    }
</pre>

<p>我们再回来说表单元素。现行可以供avalon操作的的HTML4表单元素有text, textarea, password, radio, checkbox, select，
    其中select根据multiple属性分为单选下拉框，多选下拉框。text, textarea, password比较简单，直接取其value属性同步就行了。
    radio与checkbox就需分情况讨论，如果用户就想根据此元素是否被勾选进行操作，那么就需要用ms-duplex-checked，
    如果用户就是想从多个radio或多个checkbox的value值中进行选择，就需要ms-duplex(ms-duplex-string)，ms-duplex-number, ms-duplex-boolean。
    select的值其实就是被选中的option的value值或text值。
    但select为多选下拉框时，与checkbox一样，是显示一组的东西，因此它们需要在VM中对应的一个数组。
</p>

<pre class="brush:html;gutter:false;toolbar:false">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;TODO supply a title&lt;/title&gt;
        &lt;meta charset="UTF-8"&gt;
        &lt;meta name="viewport" content="width=device-width"&gt;
        &lt;script src="../avalon.js" &gt;&lt;/script&gt;
        &lt;script&gt;
            var model = avalon.define({
                $id: "test",
                a: true,
                b: true,
                c: "",
                d: "",
                e: 10,
                f: true,
                g: ["b", "c"],
                h: [1, 4],
                i: [false],
                j: "2222",
                k: 2222,
                l: false,
                m: ["bbbb","dddd"],
                n: [11,44],
            });
            model.$watch("$all", function(a, b) {
                if (!/^avalon\-/.test(a)) {
                    avalon.log([a, b, typeof b].join("   "))
                }
            })
            model.g.$watch("length", function() {
                avalon.log(model.g)
            })
            model.h.$watch("length", function() {
                avalon.log(model.h)
            })
            model.i.$watch("length", function() {
                avalon.log(model.i)
            })
              model.m.$watch("length", function() {
                avalon.log(model.m)
            })
              model.n.$watch("length", function() {
                avalon.log(model.n)
            })
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div ms-controller="test"&gt;
            &lt;h3 style="text-align: center"&gt;ms-duplex 2.0&lt;/h3&gt;
            &lt;table&gt;
                &lt;tr&gt;
                    &lt;td&gt;
                        &lt;p&gt;ms-duplex-checked&lt;input ms-duplex-checked="a" type="radio" /&gt;{{a}}&lt;/p&gt;
                        &lt;p&gt;ms-duplex-checked&lt;input ms-duplex-checked="b" type="checkbox"/&gt;{{b}}&lt;/p&gt;
                        &lt;p&gt;ms-duplex-string&lt;input ms-duplex="c" /&gt;{{c}}&lt;/p&gt;
                        &lt;p&gt;ms-duplex-string&lt;input ms-duplex-string="d" /&gt;{{d}}&lt;/p&gt;
                        &lt;p&gt;ms-duplex-number&lt;input ms-duplex-number="e" /&gt;{{e}}&lt;/p&gt;
                        &lt;p&gt;ms-duplex-boolean&lt;input ms-duplex-boolean="f" data-duplex-event="change" /&gt;{{f}}&lt;/p&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                        &lt;p&gt;ms-duplex-string
                            &lt;input ms-duplex-string="g" type="checkbox" value="a" /&gt;
                            &lt;input ms-duplex-string="g" type="checkbox" value="b" /&gt;
                            &lt;input ms-duplex-string="g" type="checkbox" value="c" /&gt;
                            &lt;input ms-duplex-string="g" type="checkbox" value="d" /&gt;
                            {{g}}&lt;/p&gt;
                        &lt;p&gt;ms-duplex-number
                            &lt;input ms-duplex-number="h" type="checkbox" value="1" /&gt;
                            &lt;input ms-duplex-number="h" type="checkbox" value="2" /&gt;
                            &lt;input ms-duplex-number="h" type="checkbox" value="3" /&gt;
                            &lt;input ms-duplex-number="h" type="checkbox" value="4" /&gt;
                            {{h}}&lt;/p&gt;
                        &lt;p&gt;ms-duplex-boolean
                            &lt;input ms-duplex-boolean="i" type="checkbox" value="false" /&gt;
                            &lt;input ms-duplex-boolean="i" type="checkbox" value="true" /&gt;
                            {{i}}&lt;/p&gt;
                        &lt;p&gt;ms-duplex-string/ms-duplex
                            &lt;select ms-duplex="j"&gt;
                                &lt;option&gt;1111&lt;/option&gt;
                                &lt;option&gt;2222&lt;/option&gt;
                                &lt;option&gt;3333&lt;/option&gt;
                            &lt;/select&gt;
                        &lt;/p&gt;
                        &lt;p&gt;ms-duplex-number
                            &lt;select ms-duplex-number="k"&gt;
                                &lt;option&gt;1111&lt;/option&gt;
                                &lt;option&gt;2222&lt;/option&gt;
                                &lt;option&gt;3333&lt;/option&gt;
                            &lt;/select&gt;
                        &lt;/p&gt;
                        &lt;p&gt;ms-duplex-boolean
                            &lt;select ms-duplex-boolean="l"&gt;
                                &lt;option&gt;true&lt;/option&gt;
                                &lt;option&gt;false&lt;/option&gt;
                            &lt;/select&gt;
                        &lt;/p&gt;
                    &lt;/td&gt;
                    &lt;td&gt;
                        &lt;p&gt;ms-duplex-string/ms-duplex&lt;br/&gt;
                            &lt;select ms-duplex="m" multiple&gt;
                                &lt;option&gt;aaaa&lt;/option&gt;
                                &lt;option&gt;bbbb&lt;/option&gt;
                                &lt;option&gt;cccc&lt;/option&gt;
                                &lt;option&gt;dddd&lt;/option&gt;
                            &lt;/select&gt;
                        &lt;/p&gt;
                        &lt;p&gt;ms-duplex-number&lt;br/&gt;
                            &lt;select ms-duplex-number="n" multiple&gt;
                                &lt;option&gt;11&lt;/option&gt;
                                &lt;option&gt;22&lt;/option&gt;
                                &lt;option&gt;33&lt;/option&gt;
                                &lt;option&gt;44&lt;/option&gt;
                            &lt;/select&gt;
                        &lt;/p&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
            &lt;/table&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;

</pre>
<p><img src="zh/bindings/duplex/duplex1.gif" alt="enter image description here" title /></p>
<p>接着下来，我们说一下如何一开始就勾选好某些radio，checkbox。如果对应的绑定属性是ms-duplex-checked就简单了，只要让它们在VM中对应的属性为
true就行了。如果是要根据value值进行勾选，就分情况讨论。radio，要求VM中对应的属性等于某个radio的value值；checkbox，由于是一组组出现的，
因此要求在VM中对应一个数组，然后将需要选中的checkbox的值放进去就行了。我们看下例：
</p>

<pre class="brush:html;gutter:false;toolbar:false">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;ms-duplex&lt;/title&gt;
        &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"&gt;
        &lt;meta http-equiv="X-UA-Compatible" content="IE=edge" /&gt;
        &lt;script src="avalon.js" &gt;&lt;/script&gt;
        &lt;script&gt;
            var vm = avalon.define({
                $id: "test2",
                sex: "man",
                lang: ["javascript","ruby"],
                langtext: "javascript,ruby"
            })
            vm.lang.$watch("length", function(){
                vm.langtext = vm.lang.join(",")
            })

        &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div ms-controller="test2"&gt;
            &lt;p&gt;&lt;input type="radio" ms-duplex-string="sex" value="man"&gt;男
                &lt;input type="radio" ms-duplex-string="sex" value="woman"&gt;女&lt;/p&gt;
            &lt;p&gt;
                &lt;input type="checkbox" ms-duplex-string="lang" value="#C"&gt;#C
                &lt;input type="checkbox" ms-duplex-string="lang" value="java"&gt;java
                &lt;input type="checkbox" ms-duplex-string="lang" value="ruby"&gt;ruby
                &lt;input type="checkbox" ms-duplex-string="lang" value="javascript"&gt;javascript
            &lt;/p&gt;
            &lt;p&gt;{{sex}}                   {{langtext}}&lt;/P&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre>
<p><img src="zh/bindings/duplex/duplex2.gif" alt="enter image description here" title /></p>


<p>此外还有一个pipe内部方法，允许我们在ms-duplex-后面接N个单词，每个单词对应avalon.duplexHooks中一个对象，
    我们称之为<code class='language-javascript'>拦截器</code>。 </p>

<pre class="brush:javascript;gutter:false;toolbar:false">
  function pipe(val, data, action, e) {
        data.param.replace(rword, function(name) {
            var hook = avalon.duplexHooks[name]
            if (hook &amp;&amp; typeof hook[action] === "function") {
                val = hook[action](val, data)
            }
        })
        return val
    }
</pre>


<p>有了拦截器机制，我们就可以用ms-duplex做更多的事情，如<a href="https://github.com/RubyLouvre/avalon.oniui/tree/master/mask">格式化处理</a>，<a href="https://github.com/RubyLouvre/avalon.oniui/tree/master/validation">数据验证</a>，带来N多兄弟，<code class='language-javascript'>ms-duplex-mask</code>、 <code class='language-javascript'>ms-duplex-int</code>、 <code class='language-javascript'>ms-duplex-chs</code>、
    <code class='language-javascript'>ms-duplex-email</code>、 <code class='language-javascript'> ms-duplex-url</code>、
    <code class='language-javascript'>ms-duplex-id</code>……用户缺什么就在duplexHooks造什么，制定性非常强大！</p>